#!/bin/sh
#!Script is developed by Naveen

function SendMail
{
/usr/sbin/sendmail -t <<EOF
From: $GROUP_EMAIL
To: $EMAIL
Cc: $LEADS_EMAIL,$GROUP_EMAIL
Subject: Disk Space Alert of Local machine
`cat /opt/cce/naveen/Disk/alarm.mail`
EOF
}

function header
{
                echo "Dear EAMS Team,"
                echo
                echo "Please find the details of the various mount points exceeding the specified disk space capacity"

}

function display
{
                echo "_____________________________________________________________________"
                echo "Date              : `date` "
                echo "Hostname  : $HostName"
                echo "Mount Point       : $mount"
                echo "Alert Type        : $alert_type"
                echo "Capacity  : $capacity% "
                echo "Please take necessary actions to reduce the capacity below $ACAP"
                echo
                echo "_____________________________________________________________________"
                echo
}

function footer
{
                echo "Regards,"
                echo "Monitoring Applications"
}
# To Alert C4Infra team, whenever the disk space used goes beyond 96% and second alert at 98%

LOG=/opt/cce/naveen/Disk/alarm.log
MAIL=/opt/cce/naveen/Disk/alarm.mail
EMAIL=EAMSGRP@motorola.com
LEADS_EMAIL=sanjeevp@motorola.com
GROUP_EMAIL=ckb846@motorola.com

FILE=diskalarm.properties
flag=0

# Execute it every 1 hour
while :
do
   count=2
   totalcount_cmd=3

 while [ $count -lt $totalcount_cmd ]
 do

   echo "Script is started and count is $count" >>Disk.log

   header >$MAIL

   touch $LOG

   i=0
   listcount=`expr $totalcount_cmd - $count`
   cur_cmd=`tail -$listcount $FILE | head -1`

   echo $cur_cmd >>Disk.log
   echo " " >>Disk.log

   # Put the current values of the df -k into the file
  # $cur_cmd /df >DF
   df -k >DF
   while read -r ln
   do
     # Read each line from the file
           if [ "$i" -eq 0 ];then
           i=1
           continue
        fi
 echo "Line is $ln" >>Disk.log

       capacity=`echo $ln | awk '{print $5}'|tr "%" " "`
       mount=`echo $ln |awk '{print $6}'`

       echo "capacity is $capacity and mount is $mount " >>Disk.log

        if [ $capacity -ge 94 ]; then
            alert_type="Second Level"
            ACAP=94%
            HostName=$cur_cmd
            flag=1
            display | tee -a $LOG >>$MAIL
            echo "alert_type is $alert_type and IP is $cur_cmd" >>Disk.log
        else
           if [ $capacity -gt 98 ]; then
              alert_type="First Level"
              ACAP=98%
              HostName=$cur_cmd
              flag=1
              display | tee -a $LOG >>$MAIL
              echo "alert_type is $alert_type and IP is $cur_cmd" >>Disk.log
           fi
        fi

   done < DF

   # call send mail here

   footer >>$MAIL

   if [ $flag -eq "1" ];then
        SendMail
        echo "Sending the mail"
   fi
   count=`expr $count + 1`

  rm $MAIL $LOG
  flag=0
  done

sleep 1800
flag=0
done

