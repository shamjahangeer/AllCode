CREATE OR REPLACE FUNCTION SGRADAR.ms_concat(INPUT VARCHAR2) RETURN VARCHAR2
PARALLEL_ENABLE AGGREGATE USING MSCONCATIMPL;
/

CREATE OR REPLACE TYPE BODY SGRADAR.msconcatimpl
Is

  Static Function ODCIAggregateInitialize(io_SrcContext In Out MSConcatImpl)
  Return Number
  Is
  Begin
      io_SrcContext  := MSConcatImpl(Null,Null);
      io_SrcContext.Delimiter := ',';
      Return ODCIConst.Success;
  End ODCIAggregateInitialize;

  Member Function ODCIAggregateIterate(Self  In Out MSConcatImpl,
                                       Value In     Varchar2)
  Return Number
  Is
  Begin
      If Value Is Not Null Then
         If Self.ResultString Is Null Then
            if lengthb(Self.ResultString || Value) < 3990 then
			    begin
                    Self.ResultString := Self.ResultString || Value;
				exception
				    when others then null;
			    end;
            end if;
         Else
            if lengthb(Self.ResultString || Self.Delimiter || Value) < 3990 then
			    begin
                    Self.ResultString := Self.ResultString || Self.Delimiter || Value;
				exception
				    when others then null;
			    end;
            end if;
         End If;
      End If;
      Return ODCIConst.Success;
  End ODCIAggregateIterate;

  Member Function ODCIAggregateTerminate(Self          In  MSConcatImpl,
                                         o_ReturnValue Out Varchar2,
                                         i_Flags       In  Number)
  Return Number
  Is
  Begin
    o_Returnvalue := Self.ResultString;
    Return ODCIConst.Success;
  End ODCIAggregateTerminate;

  Member Function ODCIAggregateMerge(Self   In Out MSConcatImpl,
                                     i_Ctx2 In     MSConcatImpl)
  Return Number
  Is
  Begin
      If Self.ResultString Is Null And i_Ctx2.ResultString Is Not Null Then
         if lengthb(i_Ctx2.ResultString) < 3990 then
			 begin
                 Self.ResultString := i_Ctx2.ResultString;
			exception
				when others then null;
			end;
         end if;
      Elsif Self.ResultString Is Not Null And i_Ctx2.ResultString Is Not Null Then
         if lengthb(Self.ResultString || Self.Delimiter || i_Ctx2.ResultString) < 3990 then
			 begin
                 Self.ResultString := Self.ResultString || Self.Delimiter || i_Ctx2.ResultString;
			exception
				when others then null;
			end;
         end if ;
      End If;
      Return ODCIConst.Success;
  End ODCIAggregateMerge;

END;
/
